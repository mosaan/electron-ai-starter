# アーキテクチャ説明書（方向づけフェーズ／Mastra UC1 MVP対応版）

この文書は、Releio v2 方向づけフェーズで「UC1: 基本的なAI会話（Mastraベース）」を成立させるために実施した設計・実装の要点をまとめる。今後、他のコアユースケースを実装するたびに本書を改訂していく。

## 1. 目的と位置づけ

- 目的: v1のカスタムAI統合をMastraベースに置き換え、3プロセス構成（Main/Backend/Renderer）上でストリーミングチャットを成立させる最小MVPを提供すること。
- フェーズ: 方向づけフェーズ（PoCに近いがUIから操作可能）。永続化はインメモリ、MCPや圧縮などは既存経路を温存し、Mastra経路は独立。
- スコープ外: Azureプロバイダー（Mastra経路では未対応）、DB永続化、Resource/Threadスコープのメモリ共有、MCPツール連携のMastra側実装。

## 2. 追加・変更点の概要

- 依存追加: `@mastra/core@0.24.6` を導入。
- Backend:
  - `src/backend/mastra/MastraChatService.ts` を新設し、Mastraエージェントの初期化・スレッド管理・ストリーミングを担当。
  - HandlerにMastra APIを追加: `getMastraStatus` / `startMastraSession` / `streamMastraText` / `abortMastraStream`。
  - ストリーミングを非同期タスクで実行し、`mastraChatChunk`/`mastraChatEnd`/`mastraChatError`/`mastraChatAborted` イベントを逐次配信。チャンク長や累積長をログに出力。
- Renderer:
  - `src/renderer/src/lib/mastra-client.ts` を追加し、Backend APIをラップ。AbortSignal対応のAsyncGeneratorでチャンクを受信。レンダラー側でもチャンク長などをログ出力。
  - `src/renderer/src/components/MastraMvpChat.tsx` を追加し、Mastra専用の簡易チャットUIを提供。ストリーム表示とAbortをサポート。
  - `src/renderer/src/App.tsx` / `ChatPanel` / `ChatPageWithSessions` に「Mastra MVP」導線を追加。
- イベント購読仕様:
  - `Connection.onEvent` に `replayLast` オプションを追加（デフォルトは従来どおりリプレイあり）。Mastra経路はリプレイを許容しつつ `streamId` フィルタで誤混入を防止。

## 3. Mastraチャットフロー（UC1）

1. Rendererで「Mastra MVP」を開き、`startMastraSession`を呼び出して`sessionId/threadId`を取得（インメモリ管理）。
2. ユーザーメッセージを送信すると、`streamMastraText(sessionId, messages)`を呼び出し、即時戻り値として`streamId`を受け取る。
3. Backendの`MastraChatService.runStreaming`が非同期でMastraエージェントを起動し、`mastraChatChunk`を逐次送信。`mastraChatEnd`で終端、`mastraChatAborted`で中断、`mastraChatError`で失敗を通知。
4. Rendererの`mastra-client`がチャンクをAsyncGeneratorで受信し、UIへ逐次描画。AbortSignalで中断も可能。
5. 完了時に累積テキストをメモリ上の履歴に保存（セッション終了で破棄）。

## 4. 主要な設計判断

- ストリーミング非同期化: `streamMastraText`が完了までブロックするとRendererがリスナー登録前にイベントが流れ、最後にまとめて表示される問題があったため、バックグラウンド実行へ変更。
- イベントリプレイ: 早着イベントを取りこぼさないようデフォルトのリプレイを許容しつつ、`streamId`でフィルタして旧ストリームの混入を防止。
- Azure除外: Mastra経路ではAzure特有のエンドポイント対応を未検証のためサポート外と明記。OpenAI/Anthropic/Googleを優先。
- 永続化方針: MVPではBackendメモリでSession/Threadを保持。将来的にはThread/ResourceをDB化する前提で`threadId/resourceId`を返却。

## 5. ファイルとAPI

- Backend:
  - `src/backend/mastra/MastraChatService.ts`
    - `getStatus(): MastraStatus`（内部用）
    - `startSession(resourceId?): SessionRecord`
    - `streamText(sessionId, messages, publishEvent): streamId`（非同期タスク起動）
    - イベント: `mastraChatChunk`, `mastraChatEnd`, `mastraChatError`, `mastraChatAborted`, `mastraToolCall`, `mastraToolResult`
  - `src/backend/handler.ts`: 上記をRendererに公開。
- 共通/Preload:
  - `src/common/types.ts`: Mastra API型、`BackendListenerAPI`に`replayLast`オプションを追加。
  - `src/preload/server.ts`: `onEvent`にオプションを渡せるよう拡張。
- Renderer:
  - `src/renderer/src/lib/mastra-client.ts`: Mastra API呼び出しラッパー＋AsyncGenerator。
  - `src/renderer/src/components/MastraMvpChat.tsx`: Mastra専用チャットUI。
  - `src/renderer/src/App.tsx`, `ChatPanel`, `ChatPageWithSessions`: 「Mastra MVP」導線。

## 6. ログとデバッグ

- Backend: 各チャンクの`chunkIndex`/`chunkLength`/`totalLength`、完了時の`textLength`と`chunks`をINFO出力。
- Renderer: チャンク受信長、完了時の全文長をINFO出力（ログスコープは`renderer`）。
- 問題解析手順: `tmp/logs/app.log` を確認し、Backendのチャンク総数とRendererの受信ログを突き合わせる。取りこぼしがあれば`replayLast`設定や`streamId`フィルタを確認。

## 7. 既知の除外と今後

- 除外: Azureプロバイダー、DB永続化、Mastra側でのMCP呼び出し、Resource/Threadメモリ共有、圧縮・要約との統合。
- 今後: コアユースケース追加ごとに本書を改訂し、DB永続化・モデル選択UIのMastra統合・MCP連携（Mastra経路）を順次取り込む。

## 8. 受け入れ状態（本版）

- Mastra経路でのチャットがUI上でストリーミング表示されること。
- Backendログにチャンク逐次、完了ログが出ており、Renderer側でもチャンク長が記録されること。
- 既存v1チャット経路への副作用なし（独立APIとイベント名で隔離）。
