# 要求定義（UC1: Mastraベース基本AI会話MVP）

## 背景と目的

方向づけフェーズの最優先ユースケースである「UC1: 基本的なAI会話」をMastraを用いて成立させ、v1のカスタム実装を置き換える実現可能性を確認する。既存の3プロセス構成と設定UIを活用しつつ、最小限のストリーミングチャットを動かすことを目標とする。

## スコープ

- 対象: UC1（ユーザーとAIの1対1チャット）
- 非対象: MCPツール呼び出し、長期メモリ圧縮、Workflows/Agents/RAGなどの拡張機能、DBスキーマ変更
- フェーズ: 方向づけフェーズのMVP（PoCに近いが、UIから操作できる状態）

## アクター

- ユーザー: デスクトップアプリからチャットを開始する
- AIプロバイダー: Anthropic/OpenAI/Googleのいずれか（既存AI設定を利用）
- Backend（Mastra）: チャット実行とストリーミング応答の生成

## 前提・制約

- 3プロセス構成（Main/Backend/Renderer）は維持する。
- 既存のAI設定（AISettingsV2）に有効なプロバイダーとAPIキーが1つ以上登録されていること。
- APIキーは設定DBから取得する。追加の入力画面はMVPでは作らない。
- 永続化は最小限（当面はBackendプロセスのメモリ保持）。DB移行は次フェーズで検討。
- 既存のチャット機能は壊さない（新経路は隔離する）。

## 機能要求（MVP）

- R1: Mastra経路でチャットを開始できるUI導線を提供する（ホームまたはチャット画面から遷移）。
- R2: 送信したユーザーメッセージに対し、Mastra経由でAIのストリーミング応答を受け取り表示する。
- R3: セッションID/スレッドIDを表示し、同じ起動中は履歴を引き継げる（Backendメモリ保持）。
- R4: 応答中に中断（Abort）でき、UIに反映される。
- R5: 失敗時はユーザーにエラーメッセージを通知し、ログへ詳細を残す。

## 非機能要求（MVP）

- N1: 既存のRenderer/Backend APIと衝突しないプレフィックスのイベント名・メソッド名を使用する。
- N2: typecheck（最低限Node側）が通ること。
- N3: 新規依存追加は最小限にし、インストール手順を明記する。
- N4: UIは簡素でよいが、ストリーム途中の進行が視認できること（チャンク描画）。

## 成功条件

- UIからMastra経路でメッセージ送信→ストリーミング表示→完了/中断のシグナルが正しく届く。
- 既存チャット導線に副作用がない。
- typecheck:node が成功する。

## スコープ外と今後

- DBへのスレッド永続化、Resource-scopedメモリ、MCPツール、複数プロバイダー自動選択は次フェーズの検討事項として除外する。
