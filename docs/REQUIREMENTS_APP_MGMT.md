# アプリケーション管理要件

## ドキュメント情報

- **作成日**: 2025-11-18
- **バージョン**: 1.0
- **対象ユースケース**: UC-21 〜 UC-23
- **関連設計**: [自動更新](./AUTO_UPDATE.md)

## 1. UC-21: 更新を確認する

### 1.1 ユースケース概要

ユーザーがアプリケーションの新しいバージョンが利用可能か確認します。

### 1.2 事前条件

- The システム shall アプリケーションが起動している
- The システム shall インターネット接続が利用可能である

### 1.3 事後条件

- The システム shall 更新の有無がユーザーに通知されている

### 1.4 要件

#### 1.4.1 自動更新確認

**1. 起動時の自動確認**

When アプリケーションが起動した, the システム shall 3秒待機してから自動的に更新を確認する

**2. 非ブロッキング確認**

While システムが更新を確認している, the システム shall ユーザーのアプリケーション操作をブロックしない

**3. バックグラウンド確認**

The システム shall 更新確認をバックグラウンドで実行し、UIの応答性を維持する

#### 1.4.2 更新サーバーへの接続

**4. 更新設定の読み込み**

When システムが更新を確認する, the システム shall 更新サーバーURL、チャンネル情報を設定ファイル（updater.json）から読み込む

**5. 開発環境での設定**

Where アプリケーションが開発環境で実行されている, the システム shall 環境変数（ELECTRON_UPDATER_CONFIG）から更新設定を読み込む

**6. 本番環境での設定**

Where アプリケーションが本番環境（パッケージ済み）で実行されている, the システム shall 実行ファイルと同じディレクトリのupdater.jsonから設定を読み込む

**7. 設定ファイル未検出時の処理**

If 更新設定ファイルが存在しない, the システム shall 更新確認をスキップし、ログに警告を記録する

#### 1.4.3 更新の有無判定

**8. バージョン比較**

When システムが更新サーバーに接続した, the システム shall 最新バージョン（latest.yml）と現在のバージョンを比較する

**9. SHA-512署名の検証**

When 新しいバージョンが検出された, the システム shall インストーラーのSHA-512署名を検証する

**10. 更新利用可能の通知**

When 新しいバージョンが利用可能, the システム shall 更新通知ダイアログを表示する

**11. 最新バージョンの通知**

When 現在のバージョンが最新, the システム shall ログに記録し、ユーザーに通知しない（サイレント）

#### 1.4.4 エラーハンドリング

**12. ネットワークエラーの処理**

If 更新確認中にネットワークエラーが発生した, the システム shall エラーをログに記録し、ユーザーに通知せず処理を継続する

**13. サーバーエラーの処理**

If 更新サーバーがエラー（404、500等）を返した, the システム shall エラーをログに記録し、次回起動時に再試行する

**14. タイムアウトの処理**

If 更新確認が30秒以内に完了しない, the システム shall タイムアウトし、ユーザーに通知せず処理を継続する

---

## 2. UC-22: 更新をインストールする

### 2.1 ユースケース概要

ユーザーが新しいバージョンをダウンロード・インストールします。

### 2.2 事前条件

- The システム shall 新しいバージョンが利用可能であることが確認されている

### 2.3 事後条件

- The システム shall 新しいバージョンがインストールされ、アプリケーションが再起動されている

### 2.4 要件

#### 2.4.1 更新通知ダイアログ

**15. 更新情報の表示**

When 更新通知ダイアログが表示された, the システム shall 新しいバージョン番号、リリースノート概要、ダウンロードサイズを表示する

**16. ダウンロードオプションの提供**

The システム shall 更新通知ダイアログに「ダウンロード」、「後で」、「スキップ」ボタンを提供する

**17. スキップ時の挙動**

When ユーザーが「スキップ」を選択した, the システム shall この特定のバージョンの更新通知を今後表示しない

**18. 後で選択時の挙動**

When ユーザーが「後で」を選択した, the システム shall 次回起動時に再度更新を確認する

#### 2.4.2 更新のダウンロード

**19. ダウンロード開始**

When ユーザーが「ダウンロード」を選択した, the システム shall 更新ファイル（.exeインストーラー）のダウンロードを開始する

**20. ダウンロード進捗の表示**

While システムが更新をダウンロードしている, the システム shall ダウンロード進捗（パーセンテージ、ダウンロード速度）を表示する

**21. バックグラウンドダウンロード**

While システムが更新をダウンロードしている, the システム shall ユーザーがアプリケーションを継続して使用できるようにする

**22. ダウンロードキャンセル**

The システム shall ダウンロード中に「キャンセル」ボタンを提供し、ユーザーがダウンロードを中止できるようにする

#### 2.4.3 更新のインストール

**23. インストール準備完了の通知**

When ダウンロードが完了した, the システム shall インストール準備完了ダイアログを表示する

**24. インストールオプションの提供**

The システム shall インストール準備完了ダイアログに「今すぐインストール」、「終了時にインストール」ボタンを提供する

**25. 即座インストール**

When ユーザーが「今すぐインストール」を選択した, the システム shall アプリケーションを終了し、インストーラーを起動する

**26. 終了時インストール**

When ユーザーが「終了時にインストール」を選択した, the システム shall アプリケーション終了時に自動的にインストーラーを起動する

**27. インストーラーの起動**

When システムがインストーラーを起動する, the システム shall ダウンロードした.exeインストーラーを実行し、アプリケーションを終了する

#### 2.4.4 エラーハンドリング

**28. ダウンロードエラーの処理**

If ダウンロード中にエラーが発生した, the システム shall エラーメッセージを表示し、「再試行」オプションを提供する

**29. 署名検証エラーの処理**

If ダウンロードしたファイルのSHA-512署名が一致しない, the システム shall ダウンロードを拒否し、セキュリティエラーを表示する

**30. ディスク容量不足の処理**

If ダウンロード中にディスク容量不足が発生した, the システム shall エラーメッセージを表示し、必要な空き容量を通知する

---

## 3. UC-23: データベースをリセットする

### 3.1 ユースケース概要

開発環境でユーザーがデータベースを初期状態にリセットします。

### 3.2 事前条件

- The システム shall 開発環境で実行されている（MAIN_VITE_USER_DATA_PATH=./tmpが設定されている）

### 3.3 事後条件

- The システム shall データベースファイルが削除されている
- The システム shall 次回起動時に新しいデータベースが作成される

### 3.4 要件

#### 3.4.1 開発環境の検出

**31. 開発環境の判定**

The システム shall 環境変数（MAIN_VITE_USER_DATA_PATH）が"./tmp"に設定されている場合、開発環境と判定する

**32. 本番環境での無効化**

Where アプリケーションが本番環境（パッケージ済み）で実行されている, the システム shall データベースリセット機能を無効化し、メニューに表示しない

#### 3.4.2 データベースリセットの実行

**33. リセットコマンドの提供**

Where 開発環境で実行されている, the システム shall `pnpm run db:reset`コマンドを提供する

**34. リセット前の警告**

When ユーザーがデータベースリセットコマンドを実行した, the システム shall 全てのデータが削除されることを警告するメッセージを表示する

**35. データベースファイルの削除**

When ユーザーがリセットを確認した, the システム shall データベースファイル（./tmp/db/app.db）を削除する

**36. アプリケーション再起動の推奨**

When データベースが削除された, the システム shall アプリケーションを再起動するよう推奨メッセージを表示する

#### 3.4.3 リセット後の初期化

**37. 新しいデータベースの作成**

When アプリケーションがリセット後に起動した, the システム shall 新しい空のデータベースファイルを作成する

**38. マイグレーションの適用**

When 新しいデータベースが作成された, the システム shall 全てのマイグレーションを自動的に適用する

**39. デフォルト設定の生成**

When 新しいデータベースが作成された, the システム shall デフォルトのAI設定を生成しない（ユーザーが手動で設定）

#### 3.4.4 エラーハンドリング

**40. ファイル削除エラーの処理**

If データベースファイルの削除中にエラー（ファイルロック等）が発生した, the システム shall エラーメッセージを表示し、アプリケーションを終了してから再試行するよう案内する

**41. マイグレーションエラーの処理**

If 新しいデータベースへのマイグレーション適用中にエラーが発生した, the システム shall エラーメッセージを表示し、アプリケーションを停止する

---

## 4. テスト可能性

### 4.1 受け入れテストシナリオ

**シナリオ1: 更新の確認とインストール**
1. アプリケーションを起動
2. 3秒後に更新確認が自動実行されることを確認
3. 新しいバージョンが検出された場合、更新通知ダイアログが表示されることを確認
4. 「ダウンロード」ボタンをクリック
5. ダウンロード進捗が表示されることを確認
6. ダウンロード完了後、「今すぐインストール」をクリック
7. インストーラーが起動し、アプリケーションが終了することを確認
8. インストーラーが新しいバージョンをインストールすることを確認

**シナリオ2: 更新のスキップ**
1. 更新通知ダイアログで「スキップ」を選択
2. アプリケーションを再起動
3. 同じバージョンの更新通知が表示されないことを確認

**シナリオ3: データベースリセット（開発環境のみ）**
1. 開発環境でアプリケーションを起動
2. AI設定、MCPサーバー設定、セッションを作成
3. アプリケーションを終了
4. `pnpm run db:reset`コマンドを実行
5. データベースファイル（./tmp/db/app.db）が削除されることを確認
6. アプリケーションを再起動
7. 新しいデータベースが作成され、設定が全て空であることを確認

### 4.2 検証基準

- 更新確認がユーザーのアプリケーション操作をブロックしない
- ダウンロードエラー時にデータが破損しない
- 署名検証が全てのインストーラーに対して実行される
- 開発環境のみでデータベースリセットが許可される
- 本番環境でデータベースリセットが無効化される

---

## 5. 非機能要件

### 5.1 セキュリティ

**42. インストーラー署名の検証**

The システム shall ダウンロードしたインストーラーのSHA-512署名を検証し、改ざんされていないことを確認する

**43. HTTPS接続の使用**

The システム shall 更新サーバーとの通信に全てHTTPSを使用する

### 5.2 信頼性

**44. 更新失敗時のロールバック**

If 更新インストール中にエラーが発生した, the システム shall 旧バージョンを保持し、ユーザーがアプリケーションを継続使用できるようにする

**45. 部分ダウンロードの破棄**

If ダウンロードが中断された, the システム shall 部分的にダウンロードされたファイルを削除し、次回再ダウンロードする

### 5.3 ユーザビリティ

**46. リリースノートの提供**

The システム shall 更新通知ダイアログにリリースノートへのリンクを提供する

**47. 更新の柔軟性**

The システム shall ユーザーが更新を「今すぐ」または「後で」選択できるようにする

### 5.4 パフォーマンス

**48. 非ブロッキング更新**

The システム shall 更新確認とダウンロードをバックグラウンドで実行し、UIの応答性を維持する

**49. 起動時の遅延**

The システム shall 更新確認を起動から3秒後に開始し、アプリケーションの初期表示を遅延させない

---

## 6. プラットフォーム別の考慮事項

### 6.1 Windows

**50. NSISインストーラーの使用**

The システム shall Windows環境でNSISインストーラーを使用し、ユーザーごとのインストールをサポートする

**51. updater.json配置**

The システム shall Windows環境でupdater.jsonファイルを実行ファイル（.exe）と同じディレクトリに配置する

### 6.2 macOS

**52. macOS更新の非サポート**

The システム shall 現在のバージョンはmacOS自動更新をサポートしていないことをドキュメントに明記する（将来の拡張）

### 6.3 Linux

**53. Linux更新の非サポート**

The システム shall 現在のバージョンはLinux自動更新をサポートしていないことをドキュメントに明記する（将来の拡張）

---

## 7. 関連文書

- [要件定義概要](./REQUIREMENTS_OVERVIEW.md)
- [自動更新設計](./AUTO_UPDATE.md)
- [開発者向けドキュメント](./FOR_DEVELOPERS.md)

---

**作成者メモ**: 本文書はEARSフォーマットに従い、テスト可能な要件として記述されています。アプリケーションのライフサイクル管理と開発環境のサポートを重視しています。
