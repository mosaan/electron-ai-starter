# AI会話要件

## ドキュメント情報

- **作成日**: 2025-11-18
- **バージョン**: 1.0
- **対象ユースケース**: UC-06 〜 UC-09
- **関連設計**: [MCP統合設計](./MCP_INTEGRATION_DESIGN.md), [チャットエラーハンドリング](./CHAT_ERROR_HANDLING_DESIGN.md)

## 1. UC-06: モデルを選択する

### 1.1 ユースケース概要

ユーザーが会話に使用するAIモデルを、有効化されたプロバイダー設定とそのモデルリストから選択します。

### 1.2 事前条件

- The システム shall 少なくとも1つの有効なプロバイダー設定が存在する
- The システム shall 選択可能なプロバイダー設定に少なくとも1つのモデルが定義されている

### 1.3 事後条件

- The システム shall 選択されたモデル（プロバイダー設定ID + モデルID）がローカルストレージに保存されている

### 1.4 要件

#### 1.4.1 モデル選択UIの表示

**1. モデルセレクターの表示**

The システム shall チャット画面にモデル選択ドロップダウンを表示する

**2. プロバイダー設定別グルーピング**

The システム shall モデルセレクターでプロバイダー設定名ごとにモデルをグループ化して表示する

**3. 有効な設定のみ表示**

The システム shall 有効状態（enabled: true）のプロバイダー設定のみをモデルセレクターに表示する

**4. APIキー未設定の設定の無効化**

While プロバイダー設定にAPIキーが設定されていない, the システム shall その設定を選択不可（グレーアウト）として表示する

#### 1.4.2 モデル情報の表示

**5. デフォルトモデルの表示**

When モデルセレクターが開かれた, the システム shall デフォルト選択中のモデルに視覚的なマーカー（⭐）を表示する

**6. カスタムモデルのインジケーター**

The システム shall カスタムソース（source: 'custom'）のモデルに"Custom"バッジを表示する

**7. モデル数の表示**

The システム shall 各プロバイダー設定グループに含まれるモデル数を表示する

#### 1.4.3 モデル選択の保存

**8. 選択の即時保存**

When ユーザーがモデルを選択した, the システム shall 選択内容（providerConfigId、modelId）をローカルストレージに保存する

**9. 次回起動時の復元**

When チャット画面が読み込まれた, the システム shall ローカルストレージに保存された最後のモデル選択を復元する

**10. デフォルト選択のフォールバック**

If ローカルストレージにモデル選択が保存されていない, the システム shall AI設定のdefaultSelectionを使用する

**11. 選択不可能な場合のフォールバック**

If 保存されたモデル選択が無効（設定が削除/無効化、モデルが削除）, the システム shall 最初の利用可能なモデルを自動選択する

---

## 2. UC-07: メッセージを送信する

### 2.1 ユースケース概要

ユーザーがAIに対してテキストメッセージを送信します。

### 2.2 事前条件

- The システム shall モデルが選択されている
- The システム shall 選択されたプロバイダー設定に有効なAPIキーが設定されている

### 2.3 事後条件

- The システム shall ユーザーメッセージがチャット履歴に追加されている
- The システム shall AIへのリクエストが送信されている

### 2.4 要件

#### 2.4.1 メッセージ入力

**12. メッセージ入力フィールドの提供**

The システム shall チャット画面にメッセージ入力フィールド（テキストエリア）を提供する

**13. 送信ボタンの提供**

The システム shall メッセージ入力フィールドに隣接して送信ボタンを提供する

**14. キーボードショートカット**

When ユーザーがメッセージ入力フィールドでEnterキーを押下した, the システム shall メッセージを送信する（Shift+Enterで改行）

#### 2.4.2 送信前のバリデーション

**15. 空メッセージの送信防止**

If ユーザーが空白のみのメッセージを送信しようとした, the システム shall 送信を無効化し、送信ボタンをグレーアウトする

**16. モデル未選択時の送信防止**

If ユーザーがモデルを選択せずにメッセージを送信しようとした, the システム shall エラーメッセージを表示し、モデル選択を促す

**17. API接続中の多重送信防止**

While システムがAIからの応答を待機している, the システム shall 送信ボタンを無効化し、新しいメッセージの送信を防止する

#### 2.4.3 メッセージの送信

**18. ユーザーメッセージの即時表示**

When ユーザーがメッセージを送信した, the システム shall ユーザーメッセージをチャット履歴に即座に表示する

**19. 入力フィールドのクリア**

When ユーザーがメッセージを送信した, the システム shall メッセージ入力フィールドをクリアする

**20. AIリクエストの送信**

When ユーザーがメッセージを送信した, the システム shall 選択されたモデルとメッセージ履歴を含むリクエストをBackendプロセスに送信する

**21. MCPツールの自動提供**

When ユーザーがメッセージを送信した, the システム shall 有効化された全てのMCPサーバーのツールをAIリクエストに含める

#### 2.4.4 エラーハンドリング

**22. ネットワークエラーの処理**

If メッセージ送信中にネットワークエラーが発生した, the システム shall エラーメッセージをチャット履歴に表示し、リトライオプションを提供する

**23. 認証エラーの処理**

If メッセージ送信中に認証エラー（401、403）が発生した, the システム shall APIキーが無効である可能性を示すエラーメッセージを表示し、設定画面へのリンクを提供する

**24. レート制限エラーの処理**

If メッセージ送信中にレート制限エラー（429）が発生した, the システム shall レート制限に達したことを示すエラーメッセージを表示する

**25. モデル利用不可エラーの処理**

If メッセージ送信中にモデル利用不可エラー（404、モデルが存在しない）が発生した, the システム shall モデルが見つからない旨のエラーメッセージを表示し、モデルリスト更新を促す

---

## 3. UC-08: ストリーミング応答を受信する

### 3.1 ユースケース概要

ユーザーがAIからのストリーミング形式の応答をリアルタイムで受信し、画面に表示します。

### 3.2 事前条件

- The システム shall ユーザーがメッセージを送信している
- The システム shall AIプロバイダーがストリーミング応答をサポートしている

### 3.3 事後条件

- The システム shall AIの応答がチャット履歴に完全に表示されている
- The システム shall 応答がセッションデータとして保存されている

### 3.4 要件

#### 3.4.1 ストリーミング開始

**26. AIメッセージプレースホルダーの表示**

When AIからの応答が開始された, the システム shall チャット履歴にAIメッセージのプレースホルダーを表示する

**27. ローディングインジケーターの表示**

While システムがAIからの最初のトークンを待機している, the システム shall AIメッセージにローディングインジケーター（タイピングアニメーション等）を表示する

**28. 初回トークン表示の低遅延**

When AIから最初のトークンを受信した, the システム shall 100ms以内にユーザーに表示を開始する

#### 3.4.2 テキストストリーミング

**29. リアルタイムテキスト表示**

While システムがAIからテキストトークンを受信している, the システム shall 受信したトークンを即座にAIメッセージに追加表示する

**30. 自動スクロール**

While システムがストリーミング応答を受信している, the システム shall チャット画面を自動的に最新メッセージまでスクロールする

**31. Markdownレンダリング**

The システム shall AIの応答をMarkdown形式でレンダリングする（コードブロック、リスト、太字等のサポート）

**32. コードブロックのシンタックスハイライト**

When AIの応答にコードブロックが含まれる, the システム shall プログラミング言語に応じたシンタックスハイライトを適用する

#### 3.4.3 ストリーミング完了

**33. 完了状態の表示**

When AIからの応答が完了した, the システム shall ローディングインジケーターを非表示にする

**34. 応答の永続化**

When AIからの応答が完了した, the システム shall 完全な応答テキストをセッションデータとしてデータベースに保存する

**35. トークン使用量の記録**

When AIからの応答が完了した, the システム shall 使用されたトークン数（入力トークン、出力トークン、合計）をログに記録する

#### 3.4.4 ストリーミング中断

**36. ユーザーによる中断**

The システム shall ストリーミング中に「停止」ボタンを提供し、ユーザーが応答生成を中断できるようにする

**37. 中断時の部分応答保存**

When ユーザーがストリーミングを中断した, the システム shall 中断時点までの部分応答をセッションデータとして保存する

**38. 接続切断時の処理**

If ストリーミング中にネットワーク接続が切断された, the システム shall エラーメッセージを表示し、部分応答を保持する

---

## 4. UC-09: ツール呼び出しを確認する

### 4.1 ユースケース概要

ユーザーがAIによるMCPツールの実行状況と結果を確認します。

### 4.2 事前条件

- The システム shall 少なくとも1つのMCPサーバーが有効化されている
- The システム shall AIがツール呼び出しをサポートしている

### 4.3 事後条件

- The システム shall ツール呼び出しの詳細がチャット履歴に表示されている
- The システム shall ツール呼び出しがログファイルに記録されている

### 4.4 要件

#### 4.4.1 ツール呼び出しの表示

**39. ツールカードの表示**

When AIがMCPツールを呼び出した, the システム shall チャット履歴にツールカードを表示する

**40. ツール名の表示**

The システム shall ツールカードにツール名（例: "read_file"、"github_search"）を表示する

**41. 実行ステータスの表示**

The システム shall ツールカードに実行ステータス（実行中/完了/エラー）を表示する

**42. 実行中の視覚的フィードバック**

While ツールが実行中, the システム shall ツールカードにローディングインジケーターを表示する

#### 4.4.2 ツール詳細の表示

**43. 展開可能なツールカード**

The システム shall ツールカードをクリックで展開し、詳細情報を表示できるようにする

**44. 引数の表示**

When ツールカードが展開された, the システム shall ツールに渡された引数をJSON形式で表示する

**45. 結果の表示**

When ツールの実行が完了した, the システム shall ツールカードにツールの実行結果を表示する

**46. エラー詳細の表示**

If ツールの実行がエラーで終了した, the システム shall ツールカードにエラーメッセージとスタックトレース（利用可能な場合）を表示する

#### 4.4.3 マルチステップツール呼び出し

**47. ツールチェーンの表示**

When AIが複数のツールを連鎖的に呼び出した, the システム shall 各ツール呼び出しを時系列順にツールカードとして表示する

**48. ステップ数の制限**

The システム shall マルチステップツール呼び出しを最大10ステップまで許可する

**49. 無限ループ防止**

If AIが10ステップ以上のツール呼び出しを試みた, the システム shall ツール呼び出しを停止し、制限に達したことを示すメッセージを表示する

#### 4.4.4 ツールログの記録

**50. ツール呼び出しのログ記録**

When AIがMCPツールを呼び出した, the システム shall ツール名、引数、実行開始時刻をログファイルに記録する

**51. ツール結果のログ記録**

When ツールの実行が完了した, the システム shall ツール名、結果、実行時間をログファイルに記録する

**52. ツールエラーのログ記録**

If ツールの実行がエラーで終了した, the システム shall ツール名、エラーメッセージ、スタックトレースをログファイルに記録する

---

## 5. テスト可能性

### 5.1 受け入れテストシナリオ

**シナリオ1: モデル選択とメッセージ送信**
1. チャット画面を開く
2. モデルセレクターから"OpenAI Official / gpt-4o"を選択
3. "こんにちは"とメッセージを送信
4. ユーザーメッセージが即座に表示されることを確認
5. AIからのストリーミング応答がリアルタイムで表示されることを確認
6. 応答完了後、入力フィールドが再度有効化されることを確認

**シナリオ2: ツール呼び出しの確認**
1. ファイルシステムMCPサーバーを有効化
2. AIに"README.mdの内容を読んで要約して"とメッセージを送信
3. ツールカード"read_file"が表示されることを確認
4. ツールカードを展開し、引数`{"path": "README.md"}`が表示されることを確認
5. ツール実行完了後、結果（ファイル内容）が表示されることを確認
6. AIが結果を基に要約を生成することを確認

**シナリオ3: エラーハンドリング**
1. プロバイダー設定のAPIキーを無効な値に変更
2. メッセージを送信
3. 認証エラーメッセージが表示されることを確認
4. 設定画面へのリンクが提供されることを確認
5. APIキーを修正し、リトライが成功することを確認

### 5.2 検証基準

- ストリーミング応答が100ms以内に開始される（初回トークン表示）
- ツール呼び出しがリアルタイムでUI表示される
- 全てのエラー状態が明確なメッセージでユーザーに通知される
- ネットワーク障害時も部分応答が保持される
- ログファイルに全ての操作が記録される

---

## 6. 非機能要件

### 6.1 パフォーマンス

**53. ストリーミング応答の低遅延**

The システム shall AIから受信した最初のトークンを100ms以内にユーザーに表示する

**54. UI応答性の維持**

While システムがストリーミング応答を処理している, the システム shall UIの応答性を維持し、ユーザーの操作を受け付ける

### 6.2 セキュリティ

**55. APIキーの非表示**

The システム shall ログファイルやエラーメッセージにAPIキーを含めない

**56. ツール実行の透明性**

The システム shall AIによる全てのツール実行をユーザーに可視化する

### 6.3 ユーザビリティ

**57. エラーメッセージの明確性**

The システム shall エラーメッセージに問題の原因と推奨される対処法を含める

**58. 長文応答の可読性**

The システム shall 長文のAI応答に対してもスムーズなスクロールと読みやすいレイアウトを提供する

---

## 7. 関連文書

- [要件定義概要](./REQUIREMENTS_OVERVIEW.md)
- [MCP統合設計](./MCP_INTEGRATION_DESIGN.md)
- [チャットエラーハンドリング設計](./CHAT_ERROR_HANDLING_DESIGN.md)
- [ツール表示実装](./TOOL_DISPLAY_IMPLEMENTATION.md)

---

**作成者メモ**: 本文書はEARSフォーマットに従い、テスト可能な要件として記述されています。ストリーミングとツール呼び出しの透明性を重視しています。
